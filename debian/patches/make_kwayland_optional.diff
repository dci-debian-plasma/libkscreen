From: Debian/Kubuntu Qt/KDE Maintainers <debian-qt-kde@lists.debian.org>
Date: Tue, 14 Jun 2016 15:17:09 +0200
Subject: make_kwayland_optional

---
 CMakeLists.txt           |  2 +-
 autotests/CMakeLists.txt | 36 ++++++++++++++++++++----------------
 backends/CMakeLists.txt  |  4 +++-
 tests/CMakeLists.txt     |  4 +++-
 4 files changed, 27 insertions(+), 19 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index aa536d9..02266ab 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -20,7 +20,7 @@ set(REQUIRED_QT_VERSION 5.4.0)
 find_package(Qt5 ${REQUIRED_QT_VERSION} CONFIG REQUIRED Core DBus Gui Test X11Extras)
 
 # Wayland backend
-find_package(KF5Wayland CONFIG REQUIRED)
+find_package(KF5Wayland CONFIG)
 add_feature_info("KF5Wayland" KF5Wayland_FOUND "Required for building libkscreen's KWayland backend")
 
 # xrandr backend
diff --git a/autotests/CMakeLists.txt b/autotests/CMakeLists.txt
index 2c8ee3d..8b0b346 100644
--- a/autotests/CMakeLists.txt
+++ b/autotests/CMakeLists.txt
@@ -1,6 +1,9 @@
 add_definitions(-DTEST_DATA="${CMAKE_CURRENT_SOURCE_DIR}/configs/")
 
-include_directories(${CMAKE_CURRENT_BINARY_DIR} ${CMAKE_SOURCE_DIR}/tests/kwayland/)
+include_directories(${CMAKE_CURRENT_BINARY_DIR})
+if(${KF5Wayland_FOUND})
+    include_directories(${CMAKE_SOURCE_DIR}/tests/kwayland/)
+endif()
 
 macro(KSCREEN_ADD_TEST)
     foreach(_testname ${ARGN})
@@ -22,24 +25,25 @@ kscreen_add_test(testconfigmonitor)
 kscreen_add_test(testinprocess)
 kscreen_add_test(testbackendloader)
 
-set(KSCREEN_WAYLAND_LIBS
-    KF5::WaylandServer KF5::WaylandClient
-)
-
-# For WaylandConfigReader and TestServer
-set(KSCREEN_WAYLAND_SRCS
-    ${CMAKE_SOURCE_DIR}/tests/kwayland/waylandconfigreader.cpp
-    ${CMAKE_SOURCE_DIR}/tests/kwayland/waylandtestserver.cpp
-)
-include_directories(${CMAKE_CURRENT_SOURCE_DIR}/../backends/kwayland)
+if(${KF5Wayland_FOUND})
+    set(KSCREEN_WAYLAND_LIBS
+        KF5::WaylandServer KF5::WaylandClient
+    )
 
-kscreen_add_test(testkwaylandbackend)
-kscreen_add_test(testkwaylandconfig)
-kscreen_add_test(testkwaylanddpms)
+    # For WaylandConfigReader and TestServer
+    set(KSCREEN_WAYLAND_SRCS
+        ${CMAKE_SOURCE_DIR}/tests/kwayland/waylandconfigreader.cpp
+        ${CMAKE_SOURCE_DIR}/tests/kwayland/waylandtestserver.cpp
+    )
+    include_directories(${CMAKE_CURRENT_SOURCE_DIR}/../backends/kwayland)
 
-set(KSCREEN_WAYLAND_LIBS "")
-set(KSCREEN_WAYLAND_SRCS "")
+    kscreen_add_test(testkwaylandbackend)
+    kscreen_add_test(testkwaylandconfig)
+    kscreen_add_test(testkwaylanddpms)
 
+    set(KSCREEN_WAYLAND_LIBS "")
+    set(KSCREEN_WAYLAND_SRCS "")
+endif()
 
 if (ENABLE_XRANDR_TESTS)
     kscreen_add_test(textxrandr)
diff --git a/backends/CMakeLists.txt b/backends/CMakeLists.txt
index 3563e13..5f44182 100644
--- a/backends/CMakeLists.txt
+++ b/backends/CMakeLists.txt
@@ -1,6 +1,8 @@
 add_subdirectory(fake)
 add_subdirectory(qscreen)
-add_subdirectory(kwayland)
+if(${KF5Wayland_FOUND})
+	add_subdirectory(kwayland)
+endif()
 
 if(${XCB_RANDR_FOUND})
     message(STATUS "Will build xrandr backend.")
diff --git a/tests/CMakeLists.txt b/tests/CMakeLists.txt
index 1489d21..e82f7f7 100644
--- a/tests/CMakeLists.txt
+++ b/tests/CMakeLists.txt
@@ -1,4 +1,6 @@
 add_executable(printconfig testplugandplay.cpp testpnp.cpp)
 target_link_libraries(printconfig Qt5::Gui KF5::Screen)
 
-add_subdirectory(kwayland)
+if(${KF5Wayland_FOUND})
+    add_subdirectory(kwayland)
+endif()
